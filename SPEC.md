# 간호사 번표 자동 작성 프로그램 - 기능 명세서

4주 근무 스케줄 자동 생성 및 관리 시스템

## 📋 프로젝트 개요

간호사 근무표를 자동으로 생성하는 웹 애플리케이션입니다. 다양한 제약 조건을 준수하면서 공평한 근무 배분을 목표로 합니다.

---

## 📅 주요 개념

### 1주의 정의

**본 프로그램에서 1주는 일요일부터 토요일까지를 의미합니다.**

- **주 시작**: 일요일
- **주 종료**: 토요일
- **주간 휴식 규칙**: 일~토 기준으로 계산
- **주휴일**: 각 간호사가 지정한 요일 (일~토 중 1일)

이는 일반적인 월~일 기준과 다르므로 주의가 필요합니다.

---

## 📊 근무 타입

| 타입      | 한글명 | 설명                   | 우선순위 |
| --------- | ------ | ---------------------- | -------- |
| D         | 데이   | 주간 근무              | 1        |
| M         | 중간   | 중간 근무 (선택적)     | 2        |
| E         | 이브닝 | 저녁 근무              | 3        |
| N         | 나이트 | 야간 근무 (2-3일 연속) | 4        |
| OFF       | 오프   | 일반 휴무              | -        |
| WEEK_OFF  | 주휴   | 주휴일 (지정 요일)     | -        |
| ANNUAL    | 연차   | 연차 휴가              | -        |
| MENSTRUAL | 생휴   | 생리 휴가              | -        |

---

## 📐 제약 조건

### 🔴 하드 제약 조건 (반드시 지켜야 함)

#### 1. 일일 필수 인원

각 근무조별 필수 인원을 반드시 충족해야 합니다.

- **D (데이)**: 3명 **필수** (반드시 충족)
- **E (이브닝)**: 3명 **필수** (반드시 충족)
- **N (나이트)**: 2명 **필수** (반드시 충족)
- **M (중간)**: 1명 **권장** (최선을 다하지만 불가능하면 0명 허용)
- **총 9명**의 근무자 권장 (D, E, N만 필수이므로 최소 8명)

**💡 M(중간 근무) 특별 규칙**:
- D, E, N은 무조건 필수 인원 충족 (최우선)
- M은 D 직후 배정하여 성공률 극대화
- M=0은 정말 불가능한 경우에만 발생 (거의 발생하지 않음)

#### 2. 근무 순서 규칙

근무는 정해진 순서를 따라야 하며, 역순은 불가합니다.

- **허용되는 순서**: D → M → E → N → 휴일
- 같은 근무 연속 가능 (예: D → D → D)
- 건너뛰기 가능 (예: D → E, M → N)
- ❌ **역순 불가** (예: E → D, N → E, E → M 불가)
- 휴일 후에는 순서가 초기화되어 어떤 근무든 시작 가능
  - 예: 휴일 → E → N (가능)
  - 예: 휴일 → D → E (가능)
  - 예: M → 휴일 → D (가능)

#### 3. 나이트 근무 규칙

나이트 근무는 특별한 규칙을 따릅니다.

- ✅ **2일 또는 3일 연속**만 가능 (1일만 또는 4일 이상 불가)
- ✅ 나이트 1일차 후: 반드시 2일차 계속
- ✅ 나이트 2일차 후: 3일차 계속 또는 휴식
- ✅ 나이트 3일차 후: 반드시 종료
- ✅ 주휴일 충돌 방지: 나이트 시작 시 향후 2일 동안 주휴일이 없는 간호사만 배정
- ✅ 나이트 근무 후 **2일 이상 연속 휴식** 필수
- ✅ 스케줄 마지막 날 예외: 마지막 날로 끝나는 나이트 블록은 다음 스케줄로 이어질 수 있으므로 검증 제외

#### 4. 연속 근무일 제한

과도한 연속 근무를 방지합니다.

- 최대 **5일 연속 근무**까지만 가능
- 6일 이상 연속 근무 불가

#### 5. 주간 휴식 규칙 (일~토 기준)

매주 적절한 휴식을 보장합니다.

- **주휴(WEEK_OFF)**: 정확히 1일 (본인 지정 요일) - 필수
- **OFF**: 최소 1일 - 필수
- **연차/생휴**: 추가 옵션 (있으면 총 휴일이 3일 이상이 됨)
- **총 휴일**: 최소 2일 이상 (주휴 1일 + OFF 1일 필수, 연차/생휴는 추가)

**⚠️ 중요**: 연차나 생휴가 OFF를 대체할 수 없습니다. OFF는 반드시 1일 이상 필요합니다.

#### 6. 연차 신청 규칙

**연차 승인/반려 시스템 + 최대화 알고리즘**:

연차는 신청 → 스케줄 생성 → 제약조건 검증 → 승인/반려 과정을 거칩니다.

- ✅ **1단계: 연차 신청**
  - 간호사 관리 페이지에서 날짜 선택하여 신청
  - 주휴일과 겹침 여부만 즉시 검증 (겹치면 신청 불가)

- ✅ **2단계: 스케줄 생성 및 검증 (자동 최대화)**
  - 자동 생성 버튼 클릭 시 **최대 10회 시도**하여 최적 스케줄 탐색
  - 각 시도마다 신청한 연차를 하나씩 검증:
    - 연차 포함 스케줄 생성 → 제약조건 검증
    - 하드 제약 만족 시 연차 승인
    - 하드 제약 위반 시 연차 반려
  - 10회 시도 중 **연차 승인이 가장 많은 스케줄** 자동 선택
  - 모든 연차 승인 성공 시 또는 연속 3회 개선 없으면 조기 종료
  - **로딩 모달**로 진행 상황 실시간 표시

- ✅ **3단계: 승인/반려**
  - **제약조건 만족**: 연차 승인 → 스케줄에 "연차OFF"로 표시
  - **제약조건 위반**: 연차 반려 → 해당 연차는 스케줄에 반영 안 됨
  - 반려된 연차 목록 표시

- ✅ **주휴일과 연차 겹침 금지**: 주휴일과 같은 요일에는 연차 신청 불가
- ✅ **승인된 연차 수정 불가능**: 승인된 연차는 자동으로 고정 (isFixed: true)

#### 7. 이전 5일 근무

스케줄의 연속성을 보장하기 위해 이전 5일 근무 정보를 관리합니다.

- ✅ **UI 위치**: 메인 스케줄 테이블 앞에 통합 (굵은 세로 구분선으로 구분)
- ✅ **자동 생성**: 재생성 버튼 클릭 시 이전 5일도 제약조건에 맞게 자동 생성
- ✅ **제약조건 만족**: 이전 5일 + 메인 스케줄 모두 제약조건을 만족해야 함
- ✅ **수동 편집 가능**: 사용자가 클릭하여 이전 5일 근무 타입 변경 가능
- ✅ **스케줄 연결**: 이전 5일 정보를 바탕으로 메인 스케줄의 제약조건 검증

#### 8. 고정 근무/휴가

사용자가 수동으로 설정한 일정은 보호됩니다.

- 주휴일(WEEK_OFF)은 자동으로 고정됨 (isFixed: true)
- 연차(ANNUAL)도 자동으로 고정됨 (isFixed: true)
- 고정된 셀은 클릭해도 변경되지 않음
- **우클릭으로 사용자가 수동으로 고정/해제 가능** ✅

#### 9. 휴일 공평 분배 (HARD 제약) ✅

간호사들 간의 휴일 수 차이를 최소화합니다.

- **검증 범위**: 현재 4주 스케줄만 (이전 5일 근무 제외)
- **휴일 타입**: OFF + WEEK_OFF + ANNUAL + MENSTRUAL
- **하드 제약**: 차이 3일 이상이면 **하드 위반** (스케줄 생성 실패)
- **백트래킹**: 그리디 알고리즘으로 해결 안 되면 최대 150회 재시도
  - 각 시도마다 랜덤 정렬로 다양한 배정 순서 시도
  - 일반적으로 2-5회 시도 내에 성공
- **자동 배정**: 휴일이 적은 간호사 우선 배정 (공평 분배)

---

### 🟡 소프트 제약 조건 (권장사항)

#### 1. 비권장 패턴

- **E → OFF → D** 패턴 비권장
  - 가능은 하지만 권장하지 않음

#### 2. 근무 공평 분배

근무 부담을 균등하게 분산합니다.

- 총 근무일이 적은 간호사 우선 배정
- 근무 부담이 특정 간호사에게 쏠리지 않도록 조정

#### 3. 나이트 근무 공평 분배

4주 동안 총 나이트 일수가 간호사들끼리 평균 2일 이상 차이가 나지 않게 합니다.

- 예) 간호사 A: 나이트 4일, 간호사 B: 나이트 6일 → 괜찮음
- 예) 간호사 A: 나이트 4일, 간호사 B: 나이트 7일 → 권장하지 않음

#### 4. 2주 연속 나이트 근무 제한

간호사의 피로도를 고려하여 2주 연속 나이트 근무는 권장하지 않습니다.

- 연속된 2주(일~토)에 모두 나이트 근무가 있으면 SOFT 위반
- 인력 부족 시 불가피하게 발생할 수 있음
- 위반 시 노란색으로 경고만 표시
- 예시:
  - ⚠️ 1주차(1/1~1/7) 나이트 2일 + 2주차(1/8~1/14) 나이트 2일 → SOFT 위반
  - ✅ 1주차(1/1~1/7) 나이트 2일 + 2주차 건너뛰고 3주차(1/15~1/21) 나이트 2일 → 정상

#### 5. 주간 OFF 제한

주간 일반 OFF가 과도하게 많지 않도록 권장합니다.

- OFF === 0: HARD 위반 (필수 휴식 미확보)
- OFF === 1: OK (이상적) ✅
- OFF === 2-3: SOFT 위반 (나이트 후 휴식 등으로 불가피, 허용)
- OFF >= 4: HARD 위반 (과도한 휴식)

**수학적 배경**: 15명 × 4주(28일) = 420 nurse-days, 9 shifts/day × 28일 = 252 shifts, 총 휴일 168일 → 평균 주당 2.8일 휴식. 따라서 모든 간호사가 정확히 주당 2일 휴식은 불가능하며, 일부 간호사가 2-3개 OFF를 받는 것은 수학적으로 불가피합니다.

---

## 🔄 스케줄 생성 알고리즘

### 배정 순서 (현직 간호사 조언 반영)

**🔴 중요: 나이트를 먼저 배정하여 주휴일을 자연스럽게 휴식 2일에 활용**

1. **주휴일 배정** - 각 간호사의 지정 요일에 WEEK_OFF 자동 배정 (고정)
2. **연차 배정** - 승인된 연차를 ANNUAL로 배정 (고정)
3. **나이트 배정 (최우선 근무 배정)** ⭐ - 2명, 나이트 블록 관리 (2-3일 연속)
4. **데이 배정** - 3명 필수
5. **중간 배정** - 1명 권장, D 또는 M 다음만 가능
6. **이브닝 배정** - 3명 필수, D, M, E 다음만 가능
7. **나머지는 휴일** - 모두 OFF 배정

### 공평 분배 메커니즘

- 각 간호사의 총 근무일 수 추적
- 근무 배정 시 근무일이 적은 간호사 우선 선택
- 모든 근무 타입(D, M, E, N)에 동일하게 적용
- 휴일 배정 시에도 휴일이 적은 간호사 우선

### 백트래킹 알고리즘

- 그리디 알고리즘으로 모든 하드 제약을 만족하지 못하면 최대 150회 재시도
- 각 시도마다 랜덤 정렬로 다양한 배정 순서 시도
- 모든 하드 제약을 만족하는 첫 번째 스케줄 반환
- 일반적으로 2-5회 시도 내에 성공

---

## 🔧 구현 상태

### ✅ 완료된 하드 제약 조건 (9개 모두 완료!)

1. ✅ **일일 필수 인원** - D:3, E:3, N:2 필수 / M:1 권장
2. ✅ **근무 순서 규칙** - D→M→E→N, 역순 불가, 휴일 후 초기화
3. ✅ **나이트 2-3일 연속 규칙** - 주휴일 충돌 방지, 마지막 날 예외 처리
4. ✅ **연속 근무일 제한** - 최대 5일
5. ✅ **주간 휴식 규칙** - 주휴 1일 + OFF 1일 필수
6. ✅ **연차 신청 규칙** - 승인/반려 시스템, 주휴일 겹침 금지, 최대화 알고리즘
7. ✅ **이전 5일 근무** - 연속성 보장, UI 통합, 제약 조건 검증
8. ✅ **고정 근무/휴가** - 우클릭 고정/해제 기능
9. ✅ **휴일 공평 분배** - HARD 제약, 차이 3일 이상 위반, 백트래킹 알고리즘

### ✅ 완료된 소프트 제약 조건

1. ✅ **2주 연속 나이트 제한** - SOFT 위반 경고
2. ✅ **주간 OFF 제한** - 2-3개 SOFT 위반, 4개 이상 HARD 위반

### 🚧 구현 예정 (소프트 제약)

1. 🚧 **비권장 패턴 검증 (SOFT)** - E → OFF → D 패턴 감지
2. 🚧 **나이트 근무 공평 분배 검증 (SOFT)** - 차이 2일 이상 소프트 위반

### ✅ 완료된 주요 기능

1. **간호사 관리**
   - 추가/삭제/수정 기능
   - 주휴일 설정
   - 연차 신청 및 관리
   - 기본 15명 세팅 (주휴일 라운드로빈)

2. **스케줄 관리**
   - 4주 스케줄 자동 생성
   - 셀 클릭: 근무 타입 변경
   - 셀 우클릭: 고정/해제
   - 재생성 기능 (매번 다른 스케줄)
   - 이전 5일 근무 관리

3. **제약 조건 검증**
   - 실시간 위반 감지
   - 하드/소프트 구분 표시
   - 위반 내역 상세 보기
   - 필수 인원 미충족/초과 강조 표시

4. **최적화**
   - 연차 승인 최대화 알고리즘 (10회 시도, 조기 종료)
   - 성능 최적화 (250~833배 속도 향상, 2~5초 완료)
   - 백트래킹 알고리즘 (평균 2-5회 시도로 성공)
   - 로딩 모달 (진행 상황 실시간 표시)

---

## 🧪 테스트

### 테스트 통과 기준

- ✅ **전체 96개 테스트 통과** 필수
- ✅ **AND 조건**: 모든 하드 제약을 동시에 만족
- ✅ **500회 반복 테스트**: 랜덤 요소에도 제약 조건 만족
- ✅ **위반 0개**: violations.length === 0 필수
- ✅ **빌드 성공**: `npm run build` 통과 필수

### 테스트 명령어

```bash
npm run test:verbose      # 상세 출력 테스트 (권장)
npm run test:run          # 한 번만 실행
npm run test              # 감시 모드
npm run test:ui           # UI 모드
npm run build             # 빌드 확인 (필수)
```

---

## 📝 라이선스

MIT License
