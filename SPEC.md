# 간호사 스케줄 자동 생성 시스템

## 📋 개요
15명 간호사의 4주 근무표 자동 생성 웹 애플리케이션 (React + TypeScript)

## 🗓️ 주요 개념
- **1주 = 일요일~토요일** (월~일 아님!)
- **4주 스케줄** = 28일 (시작일: 일요일)
- **이전 5일 근무** = 스케줄 연속성 보장

## 📊 근무 타입

| 코드 | 한글명 | 표시 | 필수 인원 | 색상 |
|------|--------|------|-----------|------|
| D | 데이 | D | 3명 필수 | 🟨 노란색 |
| M | 중간 | M | 1명 권장 | 🩷 분홍색 |
| E | 이브닝 | E | 3명 필수 | 🔵 파란색 |
| N | 나이트 | N | 2명 필수 | 🟣 자주색 |
| OFF | 오프 | OFF | - | 🟠 주황색 |
| WEEK_OFF | 주휴 | 주휴OFF | - | 🟠 주황색 |
| ANNUAL | 연차 | 연차OFF | - | 🟠 주황색 |
| MENSTRUAL | 생휴 | 생휴 | - | 🟠 주황색 |

## 🎯 제약 조건 우선순위

**충돌 시 우선순위 (높음→낮음)**:
1. **일일 필수 인원** (D:3, E:3, N:2) - 최우선
2. **나이트 규칙** (2-3일 연속, 2일 휴식)
3. **근무 순서** (D→M→E→N)
4. **연속 근무 제한** (최대 5일)
5. **주간 휴식** (주휴 1일 + OFF 정확히 1일)
6. **2주 연속 나이트 금지**
7. **휴일 공평 분배** (총 휴일 차이 3일 이내)
8. **생휴 제한** (월별 1회)
9. **근무 제한** (D/E/N만)
10. **쉬는날 신청**
11. **고정 셀**
12. **이전 5일 근무**

## 🔴 하드 제약 (12개) - 11/12 완료

| # | 제약 조건 | 핵심 규칙 | 우선순위 | 구현 |
|---|----------|-----------|----------|------|
| 1 | **일일 필수 인원** | D:3, E:3, N:2 필수 / M:1 권장 | 1 | ✅ |
| 2 | **근무 순서** | D→M→E→N (역순 불가), 휴일 후 초기화 | 3 | ✅ |
| 3 | **나이트 규칙** | 2-3일 연속, 이후 2일 이상 휴식(주휴OFF 우선) | 2 | ✅ |
| 4 | **연속 근무 제한** | 최대 5일 | 4 | ✅ |
| 5 | **주간 휴식** | 주휴 1일 + OFF 정확히 1일 + 연차/생휴 추가 가능 | 5 | ✅ |
| 6 | **쉬는날 신청** | 자동 타입 분배 (주휴>OFF>연차) | 10 | ✅ |
| 7 | **이전 5일 근무** | 연속성 보장, UI 통합 | 12 | ✅ |
| 8 | **고정 셀** | 우클릭 고정/해제 | 11 | ✅ |
| 9 | **휴일 공평 분배** | 총 휴일(주휴+OFF+연차+생휴) 차이 3일 이상 위반 | 7 | ✅ |
| 10 | **생휴 제한** | 월별 1회 (달력 월 기준) | 8 | ✅ |
| 11 | **근무 제한** | 특정 간호사 D/E/N만 가능 | 9 | ✅ |
| 12 | **2주 연속 나이트 금지** | 연속 2주(일~토)에 모두 나이트 있으면 위반 | 6 | 🚧 |

## 🟡 소프트 제약 (3개)

| # | 제약 조건 | 규칙 | 우선순위 | 구현 |
|---|----------|------|----------|------|
| 1 | **연속 패턴** | 퐁당퐁당보다 연속 근무+연속 휴식 | 1 | 🚧 |
| 2 | **비권장 패턴** | E→OFF→D 비권장 | 2 | 🚧 |
| 3 | **나이트 공평** | 나이트 차이 2일 이내 | 3 | 🚧 |

## ⚙️ 핵심 기능

### ✅ 간호사 관리
- [x] 추가/삭제/수정
- [x] 주휴일 지정
- [x] 쉬는날 신청 (날짜만 선택)
- [x] 근무 제한 설정 (D만/E만/N만)
- [x] 기본 15명 자동 세팅

### ✅ 스케줄 생성
- [x] 4주 자동 생성 (백트래킹 최대 150회)
- [x] 쉬는날 승인 최대화 (10회 시도)
- [x] 재생성 (매번 다른 스케줄)
- [x] 로딩 모달 (진행 상황 표시)

### ✅ UI/편집
- [x] 셀 클릭: 근무 타입 변경
- [x] 우클릭: 고정/해제
- [x] 이전 5일 근무 편집
- [x] 제약 위반 실시간 표시
- [x] 색약 친화적 색상

### ✅ 검증/최적화
- [x] 하드/소프트 위반 구분
- [x] 필수 인원 애니메이션 강조
- [x] 성능: 2-5초 내 생성 (250배 향상)
- [x] 테스트: 102개 통과

## 🔄 알고리즘 순서

**배정 순서** (현직 간호사 조언 반영):
1. **주휴일** → 2. **쉬는날** → 3. **나이트** (먼저!) → 4. **데이** → 5. **중간** → 6. **이브닝** → 7. **OFF**

**🌟 나이트 배치 핵심 규칙**:
- 나이트 후 **2일 이상 휴식** 필수
- 휴식 기간에 주휴OFF가 포함되도록 **우선 배치** (필수는 아님)
- 가능 패턴: `N-N-주휴OFF-OFF`, `N-N-N-OFF-주휴OFF`, `N-N-OFF-OFF` 등
- 주휴OFF 위치를 고려하여 나이트 배치 최적화

**핵심 메커니즘**:
- 백트래킹: 실패 시 최대 150회 재시도
- 공평 분배: 휴일/근무 적은 간호사 우선
- 쉬는날 최대화: 최대 10회 시도로 최적 탐색
- 조기 종료: 완벽한 스케줄(HARD 0, SOFT 0) 발견 시 즉시 종료

## 📂 주요 파일

| 파일 | 역할 |
|------|------|
| `types.ts` | 타입 정의 |
| `scheduler.ts` | 스케줄 생성 알고리즘 |
| `validator.ts` | 제약 조건 검증 |
| `ScheduleView.tsx` | 스케줄 UI |
| `NurseManagement.tsx` | 간호사 관리 UI |

## 🧪 테스트

```bash
npm run test:verbose  # 권장 - 상세 출력
npm run test:run      # 단일 실행
npm run build         # 빌드 (필수 확인)
```

**통과 기준**:
- ✅ 102개 테스트 통과
- ✅ 500회 반복 성공
- ✅ violations.length === 0
- ✅ 빌드 성공

## 📝 문서

- **SPEC.md**: 이 파일 - 전체 상황 한눈에 파악
- **CLAUDE.md**: 세부 구현, 버그 수정 이력, 교훈 (자세한 내용)

---

**현재 상태**: 🔨 **하드 제약 11/12 완료** | 🟡 **소프트 제약 0/3 완료**

**남은 작업**:
- 하드: 2주 연속 나이트 금지
- 소프트: 연속 패턴, 비권장 패턴, 나이트 공평